name: Open PR for feature/fix branches

on:
  push:
    branches:
      - "feat/**"
      - "fix/**"

permissions:
  contents: write

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Create PR to main if not exists
        uses: actions/github-script@v6
        with:
          script: |
            const branch = github.context.ref.replace('refs/heads/', '');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Safety: only run for feat/ or fix/ prefixes (trigger already restricts, but double-check)
            if (!branch.startsWith('feat/') && !branch.startsWith('fix/')) {
              core.info(`Branch ${branch} not eligible for automatic PR. Skipping.`);
              return;
            }

            // Check for existing open PRs from this head to main
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${branch}`,
              base: 'main'
            });

            if (pulls.length > 0) {
              core.info(`Found existing PR #${pulls[0].number} from ${branch} to main. Nothing to do.`);
              return;
            }

            // Create a PR
            const title = `chore: ${branch} -> main`;
            const body = `Automatic PR from \`${branch}\` to \`main\` triggered by push.`;

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head: branch,
              base: 'main',
              body
            });

            core.info(`Created PR #${pr.number} (${pr.html_url})`);

            // Request reviewers
            try {
              const reviewers = ['marinellibr', 'gabrielrodrigues42'];
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: pr.number,
                reviewers
              });
              core.info(`Requested reviewers: ${reviewers.join(', ')}`);
            } catch (err) {
              core.warning(`Failed to request reviewers: ${err.message}`);
            }
